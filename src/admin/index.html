<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jewelry Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <!-- Netlify Identity Widget -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
        // Check if Netlify Identity Widget loaded correctly
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof netlifyIdentity === 'undefined') {
                console.error('Netlify Identity Widget failed to load!');
                // Try loading it again
                const script = document.createElement('script');
                script.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
                script.onload = function() {
                    console.log('Netlify Identity Widget loaded successfully on retry');
                    if (typeof netlifyIdentity !== 'undefined') {
                        netlifyIdentity.on('init', user => {
                            console.log('Netlify Identity initialized', user ? 'with user' : 'without user');
                        });
                    }
                };
                script.onerror = function() {
                    console.error('Failed to load Netlify Identity Widget even on retry');
                    alert('Failed to load authentication system. Please refresh the page and try again.');
                };
                document.head.appendChild(script);
            } else {
                console.log('Netlify Identity Widget loaded successfully');
            }
        });
    </script>
    <style>
        .hidden {
            display: none;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
        }
        textarea.form-control {
            min-height: 100px;
        }
        .product-list {
            margin-top: 2rem;
        }
        .product-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .product-actions {
            display: flex;
            gap: 0.5rem;
        }
        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .alert-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .alert-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .tab-container {
            margin-bottom: 2rem;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="admin-container">
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-blue-600 mb-2">Jewelry Admin</h1>
                    <p class="text-gray-600">Manage your jewelry products and categories</p>
                </div>
                <button id="logout-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-300">Logout</button>
            </div>
        </header>

        <!-- Login Form -->
        <div id="login-section" class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-bold mb-4">Admin Login</h2>
            <p class="mb-4">You need to be logged in to access the admin area.</p>
            <div class="form-group">
                <button id="netlify-login" class="btn">Login with Netlify Identity</button>
            </div>
            <div class="mt-4">
                <h3 class="font-bold mb-2">After login, you'll also need:</h3>
                <div class="form-group">
                    <label for="github-token">GitHub Personal Access Token</label>
                    <input type="password" id="github-token" class="form-control" placeholder="Enter your GitHub token">
                    <p class="text-sm text-gray-500 mt-1">
                        Need a token? <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-600 hover:underline">Create one here</a> with "repo" permissions.
                    </p>
                    <div class="mt-2 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                        <p class="text-sm font-medium text-yellow-800">Important: Your token must have full "repo" permissions</p>
                        <p class="text-xs text-yellow-700 mt-1">This includes access to private repositories, commits, issues, etc.</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-md">
                    <h4 class="text-sm font-medium text-gray-800">Repository Configuration:</h4>
                    <ul class="mt-1 text-xs text-gray-600 space-y-1">
                        <li><span class="font-medium">Owner:</span> superbrucem</li>
                        <li><span class="font-medium">Repository:</span> -git-Projects-jewelry11ty</li>
                        <li><span class="font-medium">Branch:</span> master</li>
                        <li><span class="font-medium">File Path:</span> src/_data/products.json</li>
                    </ul>
                </div>
                <button id="login-button" class="btn mt-4">Continue to Admin</button>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="font-bold mb-2">Having trouble with Netlify Identity?</h3>
                <p class="mb-4 text-sm text-gray-600">If the Netlify Identity login button doesn't work, you can use direct GitHub authentication:</p>
                <div class="form-group">
                    <label for="admin-password">Admin Password</label>
                    <input type="password" id="admin-password" class="form-control" placeholder="Enter admin password">
                </div>
                <button id="direct-login-button" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors duration-300">Login with Password</button>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alert-container" class="hidden"></div>

        <!-- Admin Panel (hidden until logged in) -->
        <div id="admin-panel" class="hidden">
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" data-tab="products">Products</button>
                    <button class="tab-button" data-tab="categories">Categories</button>
                    <button class="tab-button" data-tab="json-editor">JSON Editor</button>
                </div>

                <!-- Products Tab -->
                <div id="products-tab" class="tab-content active">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-bold mb-4">Add/Edit Product</h2>
                        <form id="product-form">
                            <input type="hidden" id="product-id" value="">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label for="product-name">Product Name</label>
                                    <input type="text" id="product-name" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-category">Category</label>
                                    <select id="product-category" class="form-control" required>
                                        <!-- Categories will be loaded here -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="product-price">Regular Price ($)</label>
                                    <input type="number" id="product-price" class="form-control" step="0.01" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-sale-price">Sale Price ($)</label>
                                    <input type="number" id="product-sale-price" class="form-control" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label for="product-image">Image URL</label>
                                    <input type="url" id="product-image" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-rating">Rating (0-5)</label>
                                    <input type="number" id="product-rating" class="form-control" step="0.1" min="0" max="5" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-reviews">Number of Reviews</label>
                                    <input type="number" id="product-reviews" class="form-control" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="product-featured" class="mr-2">
                                        Featured Product
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" id="product-on-sale" class="mr-2">
                                        On Sale
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="product-description">Description</label>
                                <textarea id="product-description" class="form-control" required></textarea>
                            </div>
                            <div class="flex justify-between">
                                <button type="submit" class="btn">Save Product</button>
                                <button type="button" id="cancel-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-300">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Products</h2>
                        <div id="product-list" class="product-list">
                            <!-- Products will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Categories Tab -->
                <div id="categories-tab" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                        <h2 class="text-xl font-bold mb-4">Add/Edit Category</h2>
                        <form id="category-form">
                            <input type="hidden" id="category-id" value="">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label for="category-id-input">Category ID</label>
                                    <input type="text" id="category-id-input" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="category-name">Category Name</label>
                                    <input type="text" id="category-name" class="form-control" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="category-description">Description</label>
                                <textarea id="category-description" class="form-control" required></textarea>
                            </div>
                            <div class="flex justify-between">
                                <button type="submit" class="btn">Save Category</button>
                                <button type="button" id="cancel-category-edit" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-medium py-2 px-4 rounded-lg transition-colors duration-300">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Categories</h2>
                        <div id="category-list" class="product-list">
                            <!-- Categories will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- JSON Editor Tab -->
                <div id="json-editor-tab" class="tab-content">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-bold mb-4">Edit JSON Directly</h2>
                        <p class="text-gray-600 mb-4">Be careful when editing JSON directly. Invalid JSON will cause errors.</p>
                        <div class="form-group">
                            <textarea id="json-editor" class="form-control" style="min-height: 400px; font-family: monospace;"></textarea>
                        </div>
                        <button id="save-json" class="btn">Save JSON</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub API configuration
        const config = {
            owner: 'superbrucem',
            repo: '-git-Projects-jewelry11ty',
            path: 'src/_data/products.json',
            branch: 'master'
        };

        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const adminPanel = document.getElementById('admin-panel');
        const alertContainer = document.getElementById('alert-container');
        const loginButton = document.getElementById('login-button');
        const netlifyLoginButton = document.getElementById('netlify-login');
        const directLoginButton = document.getElementById('direct-login-button');
        const logoutButton = document.getElementById('logout-button');
        const tokenInput = document.getElementById('github-token');
        const adminPasswordInput = document.getElementById('admin-password');
        const productForm = document.getElementById('product-form');
        const categoryForm = document.getElementById('category-form');
        const productList = document.getElementById('product-list');
        const categoryList = document.getElementById('category-list');
        const categorySelect = document.getElementById('product-category');
        const jsonEditor = document.getElementById('json-editor');
        const saveJsonButton = document.getElementById('save-json');
        const cancelEditButton = document.getElementById('cancel-edit');
        const cancelCategoryEditButton = document.getElementById('cancel-category-edit');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // State
        let token = '';
        let productsData = null;
        let currentFileSha = '';
        let editingProductId = null;
        let editingCategoryId = null;
        let netlifyUser = null;

        // Event Listeners
        netlifyLoginButton.addEventListener('click', () => {
            if (typeof netlifyIdentity !== 'undefined') {
                netlifyIdentity.open();
            } else {
                console.error('Netlify Identity Widget not loaded!');
                showAlert('Error: Netlify Identity Widget not loaded!', 'error');
            }
        });
        loginButton.addEventListener('click', handleLogin);
        directLoginButton.addEventListener('click', handleDirectLogin);
        logoutButton.addEventListener('click', () => {
            if (typeof netlifyIdentity !== 'undefined') {
                netlifyIdentity.logout();
            }
            localStorage.removeItem('github_token');
            localStorage.removeItem('admin_authenticated');
            token = '';
            productsData = null;
            currentFileSha = '';
            netlifyUser = null;
            adminPanel.classList.add('hidden');
            loginSection.classList.remove('hidden');
            showAlert('You have been logged out', 'success');
        });
        productForm.addEventListener('submit', handleProductSubmit);
        categoryForm.addEventListener('submit', handleCategorySubmit);
        saveJsonButton.addEventListener('click', handleJsonSave);
        cancelEditButton.addEventListener('click', resetProductForm);
        cancelCategoryEditButton.addEventListener('click', resetCategoryForm);

        // Netlify Identity Event Listeners
        if (typeof netlifyIdentity !== 'undefined') {
            // Use netlifyIdentity object
            netlifyIdentity.on('init', user => {
                if (user) {
                    netlifyUser = user;
                    showAlert('You are logged in with Netlify Identity', 'success');
                }
            });

            netlifyIdentity.on('login', user => {
                netlifyUser = user;
                showAlert('Successfully logged in with Netlify Identity', 'success');
                netlifyIdentity.close();
            });

            netlifyIdentity.on('logout', () => {
                netlifyUser = null;
                adminPanel.classList.add('hidden');
                loginSection.classList.remove('hidden');
                showAlert('You have been logged out', 'success');
            });
        } else {
            console.error('Netlify Identity Widget not loaded!');
            showAlert('Error: Netlify Identity Widget not loaded!', 'error');
        }

        // Tab functionality
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');

                // Update active tab button
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                // Show the selected tab content
                tabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabId}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Check for stored token and authentication status
        function checkStoredToken() {
            const storedToken = localStorage.getItem('github_token');
            const isAuthenticated = localStorage.getItem('admin_authenticated') === 'true';

            if (storedToken) {
                tokenInput.value = storedToken;

                // If we have direct authentication, bypass Netlify Identity
                if (isAuthenticated) {
                    netlifyUser = { email: 'admin@example.com' }; // Dummy user object
                    handleLogin();
                }
                // Otherwise, we'll wait for Netlify Identity to initialize
            }
        }

        // Direct login handler (password-based fallback)
        function handleDirectLogin() {
            const password = adminPasswordInput.value.trim();
            const correctPassword = 'jewelry-admin'; // Simple hardcoded password - change this!

            if (password === correctPassword) {
                // Set authenticated flag
                localStorage.setItem('admin_authenticated', 'true');
                netlifyUser = { email: 'admin@example.com' }; // Dummy user object
                showAlert('Successfully authenticated with password', 'success');

                // Continue with GitHub token login
                handleLogin();
            } else {
                showAlert('Incorrect admin password', 'error');
            }
        }

        // Login Handler
        async function handleLogin() {
            // Check if user is logged in with Netlify Identity or direct login
            if (!netlifyUser) {
                showAlert('Please login first', 'error');
                if (typeof netlifyIdentity !== 'undefined') {
                    netlifyIdentity.open();
                } else {
                    console.error('Netlify Identity Widget not loaded!');
                    showAlert('Try using the password login option below', 'error');
                }
                return;
            }

            token = tokenInput.value.trim();
            if (!token) {
                showAlert('Please enter a GitHub token', 'error');
                return;
            }

            try {
                console.log('Testing GitHub token access...');
                // Test the token by trying to get the file
                const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}`;
                console.log('Testing access to:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GitHub API error response:', errorData);

                    // More detailed error message
                    let errorMessage = errorData.message || 'Invalid token or repository access';

                    if (response.status === 401) {
                        errorMessage = 'Authentication failed. Your token may be invalid or expired.';
                    } else if (response.status === 403) {
                        errorMessage = 'Permission denied. Your token does not have the required permissions. Make sure it has full "repo" access.';
                    } else if (response.status === 404) {
                        errorMessage = 'Repository or file not found. Check the repository owner, name, and file path.';
                    }

                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Successfully retrieved file data');
                currentFileSha = data.sha;

                // Decode the content
                const content = atob(data.content);
                productsData = JSON.parse(content);

                // Store token in localStorage
                localStorage.setItem('github_token', token);

                // Show admin panel, hide login
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');

                // Initialize the admin interface
                initializeAdminInterface();

                showAlert('Successfully logged in to admin panel!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Login failed: ' + error.message, 'error');
            }
        }

        // Initialize Admin Interface
        function initializeAdminInterface() {
            // Populate categories dropdown
            populateCategorySelect();

            // Render product list
            renderProductList();

            // Render category list
            renderCategoryList();

            // Set JSON editor content
            jsonEditor.value = JSON.stringify(productsData, null, 2);
        }

        // Populate Category Select
        function populateCategorySelect() {
            categorySelect.innerHTML = '';
            productsData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // Render Product List
        function renderProductList() {
            productList.innerHTML = '';
            productsData.items.forEach(product => {
                const productElement = document.createElement('div');
                productElement.className = 'product-item';

                const categoryName = productsData.categories.find(c => c.id === product.category)?.name || product.category;

                productElement.innerHTML = `
                    <div class="product-header">
                        <h3 class="font-bold">${product.name}</h3>
                        <div class="product-actions">
                            <button class="edit-product bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded" data-id="${product.id}">Edit</button>
                            <button class="delete-product bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded" data-id="${product.id}">Delete</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                        <div><span class="font-medium">Category:</span> ${categoryName}</div>
                        <div><span class="font-medium">Price:</span> $${product.price}</div>
                        <div><span class="font-medium">Sale Price:</span> ${product.onSale ? '$' + product.salePrice : 'N/A'}</div>
                        <div><span class="font-medium">Featured:</span> ${product.featured ? 'Yes' : 'No'}</div>
                        <div><span class="font-medium">Rating:</span> ${product.rating} (${product.reviews} reviews)</div>
                    </div>
                `;

                productList.appendChild(productElement);

                // Add event listeners
                productElement.querySelector('.edit-product').addEventListener('click', () => editProduct(product.id));
                productElement.querySelector('.delete-product').addEventListener('click', () => deleteProduct(product.id));
            });
        }

        // Render Category List
        function renderCategoryList() {
            categoryList.innerHTML = '';
            productsData.categories.forEach(category => {
                const categoryElement = document.createElement('div');
                categoryElement.className = 'product-item';

                categoryElement.innerHTML = `
                    <div class="product-header">
                        <h3 class="font-bold">${category.name}</h3>
                        <div class="product-actions">
                            <button class="edit-category bg-blue-100 hover:bg-blue-200 text-blue-800 px-3 py-1 rounded" data-id="${category.id}">Edit</button>
                            <button class="delete-category bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded" data-id="${category.id}">Delete</button>
                        </div>
                    </div>
                    <div class="text-sm">
                        <div><span class="font-medium">ID:</span> ${category.id}</div>
                        <div><span class="font-medium">Description:</span> ${category.description}</div>
                    </div>
                `;

                categoryList.appendChild(categoryElement);

                // Add event listeners
                categoryElement.querySelector('.edit-category').addEventListener('click', () => editCategory(category.id));
                categoryElement.querySelector('.delete-category').addEventListener('click', () => deleteCategory(category.id));
            });
        }

        // Edit Product
        function editProduct(productId) {
            const product = productsData.items.find(p => p.id === productId);
            if (!product) return;

            // Set form values
            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-category').value = product.category;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-sale-price').value = product.salePrice || '';
            document.getElementById('product-image').value = product.image;
            document.getElementById('product-rating').value = product.rating;
            document.getElementById('product-reviews').value = product.reviews;
            document.getElementById('product-featured').checked = product.featured;
            document.getElementById('product-on-sale').checked = product.onSale;
            document.getElementById('product-description').value = product.description;

            // Set editing state
            editingProductId = productId;

            // Scroll to form
            productForm.scrollIntoView({ behavior: 'smooth' });
        }

        // Delete Product
        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                // Remove product from data
                productsData.items = productsData.items.filter(p => p.id !== productId);

                // Save to GitHub
                await saveToGitHub();

                // Update UI
                renderProductList();
                jsonEditor.value = JSON.stringify(productsData, null, 2);

                showAlert('Product deleted successfully!', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete product: ' + error.message, 'error');
            }
        }

        // Edit Category
        function editCategory(categoryId) {
            const category = productsData.categories.find(c => c.id === categoryId);
            if (!category) return;

            // Set form values
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-id-input').value = category.id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-description').value = category.description;

            // Set editing state
            editingCategoryId = categoryId;

            // Scroll to form
            categoryForm.scrollIntoView({ behavior: 'smooth' });
        }

        // Delete Category
        async function deleteCategory(categoryId) {
            // Check if any products use this category
            const productsUsingCategory = productsData.items.filter(p => p.category === categoryId);

            if (productsUsingCategory.length > 0) {
                showAlert(`Cannot delete category: ${productsUsingCategory.length} products are using it.`, 'error');
                return;
            }

            if (!confirm('Are you sure you want to delete this category?')) return;

            try {
                // Remove category from data
                productsData.categories = productsData.categories.filter(c => c.id !== categoryId);

                // Save to GitHub
                await saveToGitHub();

                // Update UI
                renderCategoryList();
                populateCategorySelect();
                jsonEditor.value = JSON.stringify(productsData, null, 2);

                showAlert('Category deleted successfully!', 'success');
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Failed to delete category: ' + error.message, 'error');
            }
        }

        // Handle Product Form Submit
        async function handleProductSubmit(event) {
            event.preventDefault();

            try {
                // Get form values
                const productId = document.getElementById('product-id').value || generateId(document.getElementById('product-name').value);
                const name = document.getElementById('product-name').value;
                const category = document.getElementById('product-category').value;
                const price = parseFloat(document.getElementById('product-price').value);
                const salePriceInput = document.getElementById('product-sale-price').value;
                const salePrice = salePriceInput ? parseFloat(salePriceInput) : null;
                const image = document.getElementById('product-image').value;
                const rating = parseFloat(document.getElementById('product-rating').value);
                const reviews = parseInt(document.getElementById('product-reviews').value);
                const featured = document.getElementById('product-featured').checked;
                const onSale = document.getElementById('product-on-sale').checked;
                const description = document.getElementById('product-description').value;

                // Create product object
                const product = {
                    id: productId,
                    name,
                    price,
                    salePrice,
                    onSale,
                    description,
                    image,
                    category,
                    featured,
                    rating,
                    reviews
                };

                // Update or add product
                if (editingProductId) {
                    // Update existing product
                    const index = productsData.items.findIndex(p => p.id === editingProductId);
                    if (index !== -1) {
                        productsData.items[index] = product;
                    }
                } else {
                    // Add new product
                    productsData.items.push(product);
                }

                // Save to GitHub
                await saveToGitHub();

                // Update UI
                renderProductList();
                resetProductForm();
                jsonEditor.value = JSON.stringify(productsData, null, 2);

                showAlert('Product saved successfully!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save product: ' + error.message, 'error');
            }
        }

        // Handle Category Form Submit
        async function handleCategorySubmit(event) {
            event.preventDefault();

            try {
                // Get form values
                const categoryId = document.getElementById('category-id-input').value;
                const name = document.getElementById('category-name').value;
                const description = document.getElementById('category-description').value;

                // Create category object
                const category = {
                    id: categoryId,
                    name,
                    description
                };

                // Update or add category
                if (editingCategoryId) {
                    // Update existing category
                    const index = productsData.categories.findIndex(c => c.id === editingCategoryId);
                    if (index !== -1) {
                        // If ID changed, update all products using this category
                        if (editingCategoryId !== categoryId) {
                            productsData.items.forEach(product => {
                                if (product.category === editingCategoryId) {
                                    product.category = categoryId;
                                }
                            });
                        }
                        productsData.categories[index] = category;
                    }
                } else {
                    // Add new category
                    productsData.categories.push(category);
                }

                // Save to GitHub
                await saveToGitHub();

                // Update UI
                renderCategoryList();
                populateCategorySelect();
                resetCategoryForm();
                jsonEditor.value = JSON.stringify(productsData, null, 2);

                showAlert('Category saved successfully!', 'success');
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Failed to save category: ' + error.message, 'error');
            }
        }

        // Handle JSON Save
        async function handleJsonSave() {
            try {
                // Parse JSON to validate
                const newData = JSON.parse(jsonEditor.value);

                // Update data
                productsData = newData;

                // Save to GitHub
                await saveToGitHub();

                // Update UI
                renderProductList();
                renderCategoryList();
                populateCategorySelect();

                showAlert('JSON saved successfully!', 'success');
            } catch (error) {
                console.error('JSON save error:', error);
                showAlert('Failed to save JSON: ' + error.message, 'error');
            }
        }

        // Save to GitHub
        async function saveToGitHub() {
            try {
                console.log('Saving to GitHub with config:', config);
                console.log('Using token (first 5 chars):', token.substring(0, 5) + '...');

                const content = JSON.stringify(productsData, null, 2);
                const encodedContent = btoa(unescape(encodeURIComponent(content)));

                const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/${config.path}`;
                console.log('API URL:', url);

                const requestBody = {
                    message: 'Update products data via admin interface',
                    content: encodedContent,
                    sha: currentFileSha,
                    branch: config.branch
                };

                console.log('Request body (without content):', {
                    message: requestBody.message,
                    sha: requestBody.sha,
                    branch: requestBody.branch
                });

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('GitHub API error response:', errorData);

                    // More detailed error message
                    let errorMessage = errorData.message || 'Failed to save to GitHub';

                    if (response.status === 401) {
                        errorMessage = 'Authentication failed. Your token may be invalid or expired.';
                    } else if (response.status === 403) {
                        errorMessage = 'Permission denied. Your token does not have the required permissions. Make sure it has full "repo" access.';
                    } else if (response.status === 404) {
                        errorMessage = 'Repository or file not found. Check the repository owner, name, and file path.';
                    } else if (response.status === 409) {
                        errorMessage = 'Conflict error. The file may have been modified elsewhere.';
                    } else if (response.status === 422) {
                        errorMessage = 'Validation failed. There might be an issue with the content format.';
                    }

                    throw new Error(errorMessage);
                }

                const data = await response.json();
                console.log('Success response:', data);
                currentFileSha = data.content.sha;

                return data;
            } catch (error) {
                console.error('GitHub save error:', error);
                throw error;
            }
        }

        // Reset Product Form
        function resetProductForm() {
            productForm.reset();
            document.getElementById('product-id').value = '';
            editingProductId = null;
        }

        // Reset Category Form
        function resetCategoryForm() {
            categoryForm.reset();
            document.getElementById('category-id').value = '';
            editingCategoryId = null;
        }

        // Generate ID from name
        function generateId(name) {
            return name.toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/[\s_-]+/g, '-')
                .replace(/^-+|-+$/g, '') + '-' + Date.now().toString().slice(-4);
        }

        // Show Alert
        function showAlert(message, type) {
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            alertContainer.classList.remove('hidden');

            // Hide after 5 seconds
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        checkStoredToken();
    </script>
</body>
</html>
